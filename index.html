<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>러시안 집시 카드</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
            padding: 20px;
            display: flex;
            gap: 20px;
            background: linear-gradient(135deg, #1a0a2a, #0a0a1a); /* Deep purple to dark blue */
            color: #e0e0e0; /* Light gray for text */
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Prevent scrollbar from background effects */
            position: relative; /* For positioning board-container */
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%"><defs><radialGradient id="g" cx="50%" cy="50%" r="50%"><stop offset="0%" stop-color="%233a2a4a" stop-opacity="0.3"/><stop offset="100%" stop-color="transparent"/></radialGradient></defs><rect width="100%" height="100%" fill="url(%23g)"/></svg>') no-repeat center center / cover;
            opacity: 0.5;
            pointer-events: none;
            z-index: -1;
        }
        h1 {
            font-family: 'Playfair Display', serif;
            color: #FFD700; /* Gold */
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
        }
        h2 {
            font-family: 'Playfair Display', serif;
            color: #B0C4DE; /* Light steel blue */
        }
        #main-container { flex: 1; }
        #board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            width: 800px;
            height: 800px;
            border: 2px solid #4a3a5a; /* Darker border */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            background-color: rgba(0, 0, 0, 0.3); /* Semi-transparent dark background */
            position: relative; /* For positioning grid items */
        }
        .card-wrapper {
            width: 160px; /* 800px / 5 */
            height: 160px; /* 800px / 5 */
            position: absolute; /* Positioned relative to body */
            transform-style: preserve-3d;
            perspective: 1000px;
            left: calc(50% - 80px);
            top: calc(50% - 80px);
            transition: transform 0.5s ease-out, left 0.5s ease-out, top 0.5s ease-out, z-index 0.1s linear;
        }
        .card-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s; /* Flip animation */
            transform: rotateY(0deg); /* Initially showing back */
        }
        .card-wrapper.flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            width: 100%;
            height: 100%;
            position: absolute;
            backface-visibility: hidden;
            border: 1px solid #5a4a6a;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #e0e0e0;
            box-shadow: inset 0 0 5px rgba(255, 215, 0, 0.2);
        }
        .card-front { background-color: rgba(255, 255, 255, 0.05); z-index: 2; transform: rotateY(180deg); }
        .card-back { background-color: #3a2a4a; transform: rotateY(0deg); }
        .card-back svg { width: 100%; height: 100%; display: block; }
        .card-id { color: #888; font-size: 18px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.3; }
        .piece { position: absolute; font-size: 11px; padding: 2px 4px; background: rgba(0, 0, 0, 0.6); border-radius: 3px; color: #FFD700; border: 1px solid rgba(255, 215, 0, 0.3); }
        .piece.highlight-piece { background-color: #FFD700; color: black; font-weight: bold; box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
        .top { top: 5px; } .right { right: 5px; text-align: right; } .bottom { bottom: 5px; } .left { left: 5px; }
        #logs-container { flex-basis: 400px; }
        #logs { border: 1px solid #4a3a5a; padding: 10px; height: 800px; overflow-y: scroll; font-family: monospace; font-size: 12px; white-space: pre-wrap; background-color: rgba(0, 0, 0, 0.3); color: #e0e0e0; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); }
        #deal-button { margin-top: 20px; padding: 10px 20px; font-size: 16px; background-color: #FFD700; color: #1a0a2a; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        #deal-button:hover { background-color: #e0b000; }
    </style>
</head>
<body>
    <div id="main-container">
        <h1>러시안 집시 카드</h1>
        <button id="deal-button">카드 배치 시작</button>
        <div id="board-container"></div>
    </div>
    <div id="logs-container">
        <h2>당신의 운세:</h2>
        <div id="logs"></div>
    </div>

    <script>
        const originalCards = [
            { id: 1, top: { image: "태양", resultAngle: 90, interpretation: "r" }, right: { image: "개", resultAngle: 180, interpretation: "r" }, bottom: { image: "소년", resultAngle: 90, interpretation: "l" }, left: { image: "길", resultAngle: 180, interpretation: "l" } },
            { id: 2, top: { image: "나뭇가지", resultAngle: 90, interpretation: "r" }, right: { image: "별", resultAngle: 180, interpretation: "r" }, bottom: { image: "영구차", resultAngle: 90, interpretation: "l" }, left: { image: "클로버", resultAngle: 180, interpretation: "l" } },
            { id: 3, top: { image: "낫", resultAngle: 270, interpretation: "l" }, right: { image: "산", resultAngle: 0, interpretation: "l" }, bottom: { image: "뱀", resultAngle: 90, interpretation: "l" }, left: { image: "나뭇가지", resultAngle: 180, interpretation: "l" } },
            { id: 4, top: { image: "성", resultAngle: 90, interpretation: "r" }, right: { image: "달", resultAngle: 180, interpretation: "r" }, bottom: { image: "기사", resultAngle: 270, interpretation: "r" }, left: { image: "고양이", resultAngle: 180, interpretation: "l" } },
            { id: 5, top: { image: "사과", resultAngle: 270, interpretation: "l" }, right: { image: "집", resultAngle: 180, interpretation: "r" }, bottom: { image: "반지", resultAngle: 90, interpretation: "l" }, left: { image: "왜가리", resultAngle: 0, interpretation: "r" } },
            { id: 6, top: { image: "꽃다발", resultAngle: 90, interpretation: "r" }, right: { image: "산", resultAngle: 180, interpretation: "r" }, bottom: { image: "편지", resultAngle: 270, interpretation: "r" }, left: { image: "돈", resultAngle: 0, interpretation: "r" } },
            { id: 7, top: { image: "수탉", resultAngle: 90, interpretation: "r" }, right: { image: "악마", resultAngle: 180, interpretation: "r" }, bottom: { image: "빵", resultAngle: 90, interpretation: "l" }, left: { image: "소년", resultAngle: 0, interpretation: "r" } },
            { id: 8, top: { image: "숲", resultAngle: 90, interpretation: "r" }, right: { image: "장작", resultAngle: 0, interpretation: "l" }, bottom: { image: "악마", resultAngle: 90, interpretation: "l" }, left: { image: "여우", resultAngle: 0, interpretation: "r" } },
            { id: 9, top: { image: "반지", resultAngle: 90, interpretation: "r" }, right: { image: "닻", resultAngle: 180, interpretation: "r" }, bottom: { image: "낫", resultAngle: 270, interpretation: "r" }, left: { image: "새", resultAngle: 0, interpretation: "r" } },
            { id: 10, top: { image: "가재", resultAngle: 90, interpretation: "r" }, right: { image: "말편자", resultAngle: 0, interpretation: "l" }, bottom: { image: "다리", resultAngle: 90, interpretation: "l" }, left: { image: "숲", resultAngle: 180, interpretation: "l" } },
            { id: 11, top: { image: "물고기", resultAngle: 270, interpretation: "l" }, right: { image: "돼지", resultAngle: 180, interpretation: "r" }, bottom: { image: "편지", resultAngle: 90, interpretation: "l" }, left: { image: "닻", resultAngle: 180, interpretation: "l" } },
            { id: 12, top: { image: "배", resultAngle: 90, interpretation: "r" }, right: { image: "쥐", resultAngle: 0, interpretation: "l" }, bottom: { image: "말", resultAngle: 90, interpretation: "l" }, left: { image: "장작", resultAngle: 0, interpretation: "r" } },
            { id: 13, top: { image: "배", resultAngle: 270, interpretation: "l" }, right: { image: "다리", resultAngle: 180, interpretation: "r" }, bottom: { image: "매듭", resultAngle: 90, interpretation: "l" }, left: { image: "꽃다발", resultAngle: 180, interpretation: "l" } },
            { id: 14, top: { image: "곰", resultAngle: 90, interpretation: "r" }, right: { image: "쥐", resultAngle: 180, interpretation: "r" }, bottom: { image: "돈", resultAngle: 90, interpretation: "l" }, left: { image: "불", resultAngle: 180, interpretation: "l" } },
            { id: 15, top: { image: "물고기", resultAngle: 90, interpretation: "r" }, right: { image: "집", resultAngle: 0, interpretation: "l" }, bottom: { image: "가재", resultAngle: 90, interpretation: "l" }, left: { image: "천칭", resultAngle: 0, interpretation: "r" } },
            { id: 16, top: { image: "천칭", resultAngle: 270, interpretation: "l" }, right: { image: "여우", resultAngle: 0, interpretation: "l" }, bottom: { image: "하트", resultAngle: 90, interpretation: "l" }, left: { image: "부엉이", resultAngle: 0, interpretation: "r" } },
            { id: 17, top: { image: "단검", resultAngle: 90, interpretation: "r" }, right: { image: "빵", resultAngle: 180, interpretation: "r" }, bottom: { image: "말", resultAngle: 270, interpretation: "r" }, left: { image: "숙녀", resultAngle: 180, interpretation: "l" } },
            { id: 18, top: { image: "수탉", resultAngle: 270, interpretation: "l" }, right: { image: "백합", resultAngle: 180, interpretation: "r" }, bottom: { image: "고양이", resultAngle: 270, interpretation: "r" }, left: { image: "하트", resultAngle: 0, interpretation: "r" } },
            { id: 19, top: { image: "백합", resultAngle: 270, interpretation: "l" }, right: { image: "개", resultAngle: 0, interpretation: "l" }, bottom: { image: "왜가리", resultAngle: 90, interpretation: "l" }, left: { image: "악수", resultAngle: 0, interpretation: "r" } },
            { id: 20, top: { image: "성", resultAngle: 270, interpretation: "l" }, right: { image: "악수", resultAngle: 0, interpretation: "l" }, bottom: { image: "새", resultAngle: 90, interpretation: "l" }, left: { image: "클로버", resultAngle: 0, interpretation: "r" } },
            { id: 21, top: { image: "도로", resultAngle: 90, interpretation: "r" }, right: { image: "단검", resultAngle: 0, interpretation: "l" }, bottom: { image: "별", resultAngle: 90, interpretation: "l" }, left: { image: "책", resultAngle: 0, interpretation: "r" } },
            { id: 22, top: { image: "달", resultAngle: 270, interpretation: "l" }, right: { image: "영구차", resultAngle: 180, interpretation: "r" }, bottom: { image: "숙녀", resultAngle: 270, interpretation: "r" }, left: { image: "곰", resultAngle: 180, interpretation: "l" } },
            { id: 23, top: { image: "천사", resultAngle: 270, interpretation: "l" }, right: { image: "책", resultAngle: 0, interpretation: "l" }, bottom: { image: "뱀", resultAngle: 270, interpretation: "r" }, left: { image: "매듭", resultAngle: 0, interpretation: "r" } },
            { id: 24, top: { image: "말편자", resultAngle: 90, interpretation: "r" }, right: { image: "사과", resultAngle: 180, interpretation: "r" }, bottom: { image: "태양", resultAngle: 90, interpretation: "l" }, left: { image: "천사", resultAngle: 0, interpretation: "r" } },
            { id: 25, top: { image: "기사", resultAngle: 270, interpretation: "l" }, right: { image: "불", resultAngle: 180, interpretation: "r" }, bottom: { image: "돼지", resultAngle: 90, interpretation: "l" }, left: { image: "부엉이", resultAngle: 180, interpretation: "l" } }
        ];

        const boardContainer = document.getElementById('board-container');
        const logsContainer = document.getElementById('logs');
        const dealButton = document.getElementById('deal-button');
        let gameBoard = [];
        let visualRotations = [];

        const directions = ['top', 'right', 'bottom', 'left'];
        const dirToIndex = { top: 0, right: 1, bottom: 2, left: 3 };

        const angleToDirection = {
            0: "1번 방향",
            270: "2번 방향",
            90: "3번 방향",
            180: "4번 방향"
        };

        const dealingOrder = [
            [0, 4], [0, 3], [0, 2], [0, 1], [0, 0],
            [1, 0], [1, 1], [1, 2], [1, 3], [1, 4],
            [2, 0], [2, 1], [2, 2], [2, 3], [2, 4],
            [3, 0], [3, 1], [3, 2], [3, 3], [3, 4],
            [4, 0], [4, 1], [4, 2], [4, 3], [4, 4]
        ];

        function logMessage(message) {
            logsContainer.innerHTML += message + '\n';
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function setupBoard() {
            const shuffledCards = originalCards.map(card => ({ id: card.id, top: { ...card.top }, right: { ...card.right }, bottom: { ...card.bottom }, left: { ...card.left } }));
            shuffleArray(shuffledCards);
            const board = Array(5).fill(null).map(() => Array(5).fill(null));
            visualRotations = Array(5).fill(null).map(() => Array(5).fill(0));
            let cardIndex = 0;
            for (const [row, col] of dealingOrder) {
                if (cardIndex < shuffledCards.length) {
                    board[row][col] = shuffledCards[cardIndex++];
                }
            }
            return board;
        }

        function createCardElement(cardData, row, col) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'card-wrapper';
            cardWrapper.dataset.row = row;
            cardWrapper.dataset.col = col;
            cardWrapper.style.left = 'calc(50% - 80px)';
            cardWrapper.style.top = 'calc(50% - 80px)';
            cardWrapper.style.zIndex = 0;

            const cardInner = document.createElement('div');
            cardInner.className = 'card-inner';

            const cardFront = document.createElement('div');
            cardFront.className = 'card-front';
            cardFront.innerHTML = `
                <div class="card-id">${cardData.id}</div>
                <div class="piece top">${cardData.top.image}</div>
                <div class="piece right">${cardData.right.image}</div>
                <div class="piece bottom">${cardData.bottom.image}</div>
                <div class="piece left">${cardData.left.image}</div>
            `;

            const cardBack = document.createElement('div');
            cardBack.className = 'card-back';
            cardBack.innerHTML = `
                <svg viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg">
                    <defs><radialGradient id="bg1" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#1a0a2a"/><stop offset="100%" stop-color="#0a0a1a"/></radialGradient></defs>
                    <rect width="180" height="180" fill="url(#bg1)" />
                    <circle cx="90" cy="90" r="60" fill="none" stroke="#FFD700" stroke-width="1.2" />
                    <circle cx="90" cy="90" r="50" fill="none" stroke="#FFD700" stroke-dasharray="3 2" stroke-width="0.8" />
                    <g stroke="#FFD700" stroke-width="0.3">${[...Array(36)].map((_, i) => `<line x1="90" y1="90" x2="${90 + 60 * Math.cos(i*10*Math.PI/180)}" y2="${90 + 60 * Math.sin(i*10*Math.PI/180)}" />`).join('')}</g>
                    <g font-size="8" fill="#FFD700" font-family="serif">${[...Array(24)].map((_, i) => `<text x="${90 + 68 * Math.cos((i*15-90)*Math.PI/180)}" y="${90 + 68 * Math.sin((i*15-90)*Math.PI/180)}" text-anchor="middle" alignment-baseline="middle" transform="rotate(${i*15} ${90 + 68 * Math.cos((i*15-90)*Math.PI/180)} ${90 + 68 * Math.sin((i*15-90)*Math.PI/180)})" >${String.fromCharCode(0x16A0 + (i % 26))}</text>`).join('')}</g>
                    <polygon points="90,60 98,84 122,84 102,100 110,124 90,110 70,124 78,100 58,84 82,84" fill="none" stroke="#FFD700" stroke-width="1" />
                    <circle cx="90" cy="90" r="2" fill="#FFD700" />
                </svg>
            `;

            cardInner.appendChild(cardFront);
            cardInner.appendChild(cardBack);
            cardWrapper.appendChild(cardInner);
            return cardWrapper;
        }

        function renderBoardInitial() {
            boardContainer.innerHTML = '';
            document.querySelectorAll('.card-wrapper').forEach(c => c.remove());
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 5; col++) {
                    const cardData = gameBoard[row][col];
                    if (!cardData) continue;
                    const cardElement = createCardElement(cardData, row, col);
                    document.body.appendChild(cardElement);
                }
            }
        }

        async function dealCards() {
            dealButton.disabled = true;
            gameBoard = setupBoard();
            renderBoardInitial();
            logsContainer.innerHTML = '';
            document.querySelectorAll('.highlight-piece').forEach(el => el.classList.remove('highlight-piece'));

            const allCardWrappers = Array.from(document.querySelectorAll('.card-wrapper'));

            const shuffleIterations = 7;
            const shuffleDurationPerIteration = 800;
            for (let i = 0; i < shuffleIterations; i++) {
                allCardWrappers.forEach((wrapper) => {
                    wrapper.style.transition = 'transform 0.5s ease-out'; 
                    wrapper.classList.remove('flipped'); 
                    const randomX = (Math.random() - 0.5) * 250;
                    const randomY = (Math.random() - 0.5) * 250; 
                    const randomRotate = (Math.random() - 0.5) * 360;
                    wrapper.style.transform = `translate(${randomX}px, ${randomY}px) rotate(${randomRotate}deg)`;
                    wrapper.style.zIndex = Math.floor(Math.random() * 25); 
                });
                await new Promise(resolve => setTimeout(resolve, shuffleDurationPerIteration));
            }

            const gatherToCenterDuration = 1000;
            allCardWrappers.forEach((wrapper) => {
                wrapper.style.transition = `transform ${gatherToCenterDuration / 1000}s ease-in-out, left ${gatherToCenterDuration / 1000}s ease-in-out, top ${gatherToCenterDuration / 1000}s ease-in-out, z-index 0.5s linear`;
                wrapper.style.left = 'calc(50% - 80px)';
                wrapper.style.top = 'calc(50% - 80px)';
                const finalGatherRotate = (Math.random() - 0.5) * 30;
                wrapper.style.transform = `rotate(${finalGatherRotate}deg)`;
                wrapper.style.zIndex = 0;
            });
            await new Promise(resolve => setTimeout(resolve, gatherToCenterDuration + 100));

            const moveToBottomRightDuration = 800;
            const targetLeftForDeck = window.innerWidth - 20 - 160;
            const targetTopForDeck = window.innerHeight - 20 - 160;
            allCardWrappers.forEach((wrapper) => {
                wrapper.style.transition = `transform ${moveToBottomRightDuration / 1000}s ease-in-out, left ${moveToBottomRightDuration / 1000}s ease-in-out, top ${moveToBottomRightDuration / 1000}s ease-in-out`;
                wrapper.style.left = `${targetLeftForDeck}px`;
                wrapper.style.top = `${targetTopForDeck}px`;
                wrapper.style.transform = `rotate(${wrapper.style.transform.match(/rotate\(([^)]+)\)/)?.[1] || 0}deg)`;
                wrapper.style.zIndex = 0;
            });
            await new Promise(resolve => setTimeout(resolve, moveToBottomRightDuration + 500));

            const dealingMoveDuration = 500;
            const dealingFlipDuration = 800;
            const dealingDelayBetweenCards = 200;
            const boardRect = boardContainer.getBoundingClientRect();

            for (let i = 0; i < dealingOrder.length; i++) {
                const [row, col] = dealingOrder[i];
                const cardWrapper = document.querySelector(`.card-wrapper[data-row='${row}'][data-col='${col}']`);

                if (cardWrapper) {
                    const finalTargetLeft = boardRect.left + col * 160;
                    const finalTargetTop = boardRect.top + row * 160;

                    cardWrapper.style.transition = `transform ${dealingMoveDuration / 1000}s ease-out, left ${dealingMoveDuration / 1000}s ease-out, top ${dealingMoveDuration / 1000}s ease-out`;
                    cardWrapper.style.left = `${finalTargetLeft}px`;
                    cardWrapper.style.top = `${finalTargetTop}px`;

                    // --- 이 부분에 초기 회전 로직 추가 --- 
                    const initialRotationCount = Math.floor(Math.random() * 4); // 0, 1, 2, or 3 rotations
                    const initialRotationAngle = initialRotationCount * 90;

                    // visualRotations 업데이트
                    visualRotations[row][col] = initialRotationAngle;

                    // gameBoard의 카드 데이터도 회전
                    gameBoard[row][col] = rotateCardData(gameBoard[row][col], initialRotationCount);
                    // --- 초기 회전 로직 끝 ---

                    cardWrapper.style.transform = `rotateZ(${visualRotations[row][col]}deg)`;
                    cardWrapper.style.zIndex = 100 + i;

                    await new Promise(resolve => setTimeout(resolve, dealingMoveDuration));

                    cardWrapper.classList.add('flipped');
                    await new Promise(resolve => setTimeout(resolve, dealingFlipDuration));

                    await checkAndProcessMatchesForCard(row, col, gameBoard);

                    await new Promise(resolve => setTimeout(resolve, dealingDelayBetweenCards));
                }
            }
            
            logMessage("\n당신의 현재\n");
            const lastCard = gameBoard[4][4];
            if (lastCard) {
                logMessage(`${lastCard.top.image} (${angleToDirection[lastCard.top.resultAngle]})`);
                logMessage(`${lastCard.right.image} (${angleToDirection[lastCard.right.resultAngle]})`);
                logMessage(`${lastCard.bottom.image} (${angleToDirection[lastCard.bottom.resultAngle]})`);
                logMessage(`${lastCard.left.image} (${angleToDirection[lastCard.left.resultAngle]})`);
            }
            logMessage("\n당신의 미래\n");
            if (lastCard) {
                const futureCard = { ...lastCard };
                for (const dir of directions) {
                    if (futureCard[dir] && futureCard[dir].image !== "영구차") {
                        futureCard[dir].resultAngle = 0; // Set to 1번 방향
                    }
                }
                logMessage(`${futureCard.top.image} (${angleToDirection[futureCard.top.resultAngle]})`);
                logMessage(`${futureCard.right.image} (${angleToDirection[futureCard.right.resultAngle]})`);
                logMessage(`${futureCard.bottom.image} (${angleToDirection[futureCard.bottom.resultAngle]})`);
                logMessage(`${futureCard.left.image} (${angleToDirection[futureCard.left.resultAngle]})`);
            }
            dealButton.disabled = false;
        }

        function findMatchingPieces(card1, card2) {
            if (!card1 || !card2) return [];
            const matches = [];
            for (const dir1 of directions) {
                for (const dir2 of directions) {
                    if (card1[dir1] && card2[dir2] && card1[dir1].image === card2[dir2].image) {
                        matches.push({ image: card1[dir1].image, dir1: dir1, dir2: dir2 });
                    }
                }
            }
            return matches;
        }
        
        function rotateCardData(card, rotations) {
            if (rotations === 0) return card;
            const currentPieces = [card.top, card.right, card.bottom, card.left];
            const newPieces = Array(4).fill(null);

            for (let i = 0; i < 4; i++) {
                const originalPiece = currentPieces[i];
                if (originalPiece) {
                    // Calculate the new resultAngle without modifying the original object
                    const newResultAngle = (originalPiece.resultAngle + (rotations * 90)) % 360;
                    const finalAngle = newResultAngle < 0 ? newResultAngle + 360 : newResultAngle;

                    // Create a new piece object with the calculated new angle
                    const rotatedPiece = { ...originalPiece, resultAngle: finalAngle };

                    // Place the rotated piece in its new position
                    newPieces[(i + rotations) % 4] = rotatedPiece;
                }
            }
            return { ...card, top: newPieces[0], right: newPieces[1], bottom: newPieces[2], left: newPieces[3] };
        }

        async function applyRotation(row, col, rotationAngle) {
            const cardWrapper = document.querySelector(`.card-wrapper[data-row='${row}'][data-col='${col}']`);
            if (!cardWrapper) return;

            if (row === 4 && col === 4) {
                const originalAngle = visualRotations[row][col];
                const targetAngle = (originalAngle + rotationAngle) % 360;

                visualRotations[row][col] = targetAngle;

                cardWrapper.style.transition = 'transform 0.6s ease-in-out';
                cardWrapper.style.transform = `rotateZ(${targetAngle}deg)`;

                setTimeout(() => {
                    const cardToRevert = document.querySelector(`.card-wrapper[data-row='${row}'][data-col='${col}']`);
                    if (cardToRevert) {
                        cardToRevert.style.transition = 'transform 0.6s ease-in-out';
                        cardToRevert.style.transform = `rotateZ(${originalAngle}deg)`;
                    }
                }, 3500);

                await new Promise(resolve => setTimeout(resolve, 600));

            } else {
                visualRotations[row][col] = (visualRotations[row][col] + rotationAngle) % 360;
                cardWrapper.style.transition = 'transform 0.6s ease-in-out';
                cardWrapper.style.transform = `rotateZ(${visualRotations[row][col]}deg)`;
                await new Promise(resolve => setTimeout(resolve, 600));
            }
        }

        function highlightPieceByImage(row, col, imageName) {
            const cardElement = document.querySelector(`.card-wrapper[data-row='${row}'][data-col='${col}'] .card-front`);
            if (cardElement) {
                const pieces = cardElement.querySelectorAll('.piece');
                for (const piece of pieces) {
                    if (piece.textContent.includes(imageName)) {
                        piece.classList.add('highlight-piece');
                        break; 
                    }
                }
            }
        }

        async function checkAndProcessMatchesForCard(row, col, board) {
            if (!board[row][col]) return;

            const processMatching = async (card1Info, card2Info, targetDir1, targetDir2) => {
                const [r1, c1] = card1Info;
                const [r2, c2] = card2Info;
                
                let card1 = board[r1][c1];
                let card2 = board[r2][c2];
                if (!card1 || !card2) return;

                const images1 = new Set(directions.map(d => card1[d] && card1[d].image).filter(Boolean));
                const images2 = new Set(directions.map(d => card2[d] && card2[d].image).filter(Boolean));
                const matchingImages = [...images1].filter(img => images2.has(img));

                for (const image of matchingImages) {
                    card1 = board[r1][c1];
                    card2 = board[r2][c2];

                    const dir1 = directions.find(d => card1[d] && card1[d].image === image);
                    const dir2 = directions.find(d => card2[d] && card2[d].image === image);

                    if (!dir1 || !dir2) continue;
                    
                    const rot1_needed = (dirToIndex[targetDir1] - dirToIndex[dir1] + 4) % 4;
                    if (rot1_needed > 0) {
                        await applyRotation(r1, c1, rot1_needed * 90);
                        board[r1][c1] = rotateCardData(card1, rot1_needed);
                    }
                    
                    const rot2_needed = (dirToIndex[targetDir2] - dirToIndex[dir2] + 4) % 4;
                    if (rot2_needed > 0) {
                        await applyRotation(r2, c2, rot2_needed * 90);
                        board[r2][c2] = rotateCardData(card2, rot2_needed);
                    }

                    const finalCard1 = board[r1][c1];
                    const finalPiece1 = finalCard1[targetDir1];
                    const angleToDirection = {
                        0: "1번 방향",
                        270: "2번 방향",
                        90: "3번 방향",
                        180: "4번 방향"
                    };
                    logMessage(`${image} (${angleToDirection[finalPiece1.resultAngle]})`);

                    highlightPieceByImage(r1, c1, image);
                    highlightPieceByImage(r2, c2, image);
                }
            };

            // --- 수평 매치 확인 ---
            if (row === 0 && col < 4) { // 0행: R -> L 배치
                await processMatching([row, col], [row, col + 1], 'right', 'left');
            } else if (row > 0 && col > 0) { // 1~4행: L -> R 배치
                 await processMatching([row, col - 1], [row, col], 'right', 'left');
            }

            // --- 수직 매치 확인 ---
            if (row > 0) {
                await processMatching([row - 1, col], [row, col], 'bottom', 'top');
            }
        }

        dealButton.addEventListener('click', dealCards);
        gameBoard = setupBoard();
        renderBoardInitial();

    </script>
</body>
</html>